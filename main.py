import asyncio
import os
from google.cloud import firestore

from functions_framework import http
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ReplyKeyboardRemove,
)
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firestore
DB = firestore.Client()

# === ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –±—Ä–∏—Ñ–æ–≤ ===
CHANNEL_ID = "-1002903538672"

# === –≠—Ç–∞–ø—ã —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ ===
(
    STEP_TYPE,
    STEP_FEATURES,
    STEP_TIMELINE,
    STEP_BUDGET,
    STEP_BUSINESS_NICHE,
    STEP_COMPANY_INFO,
    STEP_INSPIRATION,
    STEP_AVAILABLE_MATERIALS,
    STEP_SEO_KEYWORDS,
    STEP_COMPETITORS,
    STEP_PRODUCT_PROBLEM,
    STEP_SITE_GOALS,
    STEP_SITE_STYLE,
    STEP_SITE_STRUCTURE,
    STEP_EXTRA_INFO,
    STEP_CONTACT,
    EDITING,
) = range(17)

# === –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã ===
def get_edit_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å", callback_data="edit_brief")]
    ])

def get_save_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚úÖ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞", callback_data="save_and_resend")],
        [InlineKeyboardButton("‚ùå –û—Ç–º–µ–Ω–∞", callback_data="cancel_edit")]
    ])

def get_type_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–í–∏–∑–∏—Ç–∫–∞", callback_data="step1:–í–∏–∑–∏—Ç–∫–∞")],
        [InlineKeyboardButton("–õ–µ–Ω–¥–∏–Ω–≥", callback_data="step1:–õ–µ–Ω–¥–∏–Ω–≥")],
        [InlineKeyboardButton("–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω", callback_data="step1:–ò–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω")],
        [InlineKeyboardButton("–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç", callback_data="step1:–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç")],
    ])

def get_features_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–ß–∞—Ç-–±–æ—Ç", callback_data="step2:–ß–∞—Ç-–±–æ—Ç")],
        [InlineKeyboardButton("–û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞", callback_data="step2:–û–Ω–ª–∞–π–Ω-–æ–ø–ª–∞—Ç–∞")],
        [InlineKeyboardButton("–ê–¥–º–∏–Ω–∫–∞", callback_data="step2:–ê–¥–º–∏–Ω–∫–∞")],
        [InlineKeyboardButton("–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ", callback_data="step2:–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ")],
        [InlineKeyboardButton("–ù–µ—Ç –Ω–∏—á–µ–≥–æ", callback_data="step2:–ù–µ—Ç")],
    ])

def get_timeline_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–°—Ä–æ—á–Ω–æ (1‚Äì2 –Ω–µ–¥–µ–ª–∏)", callback_data="step3:–°—Ä–æ—á–Ω–æ")],
        [InlineKeyboardButton("1‚Äì2 –º–µ—Å—è—Ü–∞", callback_data="step3:1-2 –º–µ—Å—è—Ü–∞")],
        [InlineKeyboardButton("–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ", callback_data="step3:–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ")],
    ])

def get_budget_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–î–æ 1000$", callback_data="step4:–î–æ 1000$")],
        [InlineKeyboardButton("1000‚Äì3000$", callback_data="step4:1000‚Äì3000$")],
        [InlineKeyboardButton("3000‚Äì7000$", callback_data="step4:3000‚Äì7000$")],
        [InlineKeyboardButton("–ë–æ–ª–µ–µ 7000$", callback_data="step4:–ë–æ–ª–µ–µ 7000$")],
    ])

def get_goals_keyboard():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("–†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–µ", callback_data="step8:–†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ø—Ä–æ–¥—É–∫—Ç–µ")],
        [InlineKeyboardButton("–†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –ª–∏—á–Ω–æ—Å—Ç–∏", callback_data="step8:–†–∞—Å—Å–∫–∞–∑–∞—Ç—å –æ –≤–∞—à–µ–π –ª–∏—á–Ω–æ—Å—Ç–∏")],
        [InlineKeyboardButton("–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é", callback_data="step8:–£–≤–µ–ª–∏—á–∏—Ç—å –∫–æ–Ω–≤–µ—Ä—Å–∏—é")],
        [InlineKeyboardButton("–£–≤–µ–ª–∏—á–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å", callback_data="step8:–£–≤–µ–ª–∏—á–∏—Ç—å –ª–æ—è–ª—å–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤")],
        [InlineKeyboardButton("–î—Ä—É–≥–æ–µ", callback_data="step8:–î—Ä—É–≥–æ–µ")],
    ])


# === –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è Cloud Functions ===
@http
def telegram_bot(request):
    return asyncio.run(handle_request(request))


async def handle_request(request):
    token = os.environ.get("TELEGRAM_BOT_TOKEN")
    if not token:
        print("ERROR: TELEGRAM_BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω")
        return "No token", 500

    app = Application.builder().token(token).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))

    if request.method == "GET":
        webhook_url = f"https://{request.host}/telegram_bot"
        await app.bot.set_webhook(webhook_url)
        return "Webhook set", 200

    if not request.is_json:
        return "Bad Request", 400

    update = Update.de_json(request.get_json(), app.bot)
    async with app:
        await app.process_update(update)

    return "OK", 200


# === –õ–æ–≥–∏–∫–∞ –±–æ—Ç–∞ ===
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    doc_ref = DB.collection("users").document(str(user_id))

    try:
        if doc_ref.get().exists:
            doc_ref.delete()
    except Exception as e:
        print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—É—é —Å–µ—Å—Å–∏—é: {e}")

    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! üëã\n"
        "–Ø –ø–æ–º–æ–≥—É –≤–∞–º –∑–∞–ø–æ–ª–Ω–∏—Ç—å –±—Ä–∏—Ñ –Ω–∞ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫—É —Å–∞–π—Ç–∞.\n"
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å:"
    )

    keyboard = InlineKeyboardMarkup([
        [InlineKeyboardButton("–ó–∞–ø–æ–ª–Ω–∏—Ç—å –±—Ä–∏—Ñ", callback_data="start_brief")]
    ])
    await update.message.reply_text("–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å?", reply_markup=keyboard)


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_id = query.from_user.id
    doc_ref = DB.collection("users").document(str(user_id))

    data = query.data

    try:
        if data == "start_brief":
            await query.edit_message_text("üîπ –®–∞–≥ 1: –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Å–∞–π—Ç–∞:")
            await query.edit_message_reply_markup(reply_markup=get_type_keyboard())

        elif data.startswith("step1:"):
            type_ = data.split(":", 1)[1]
            doc_ref.set({"type": type_, "step": STEP_FEATURES})
            await query.edit_message_text("üîπ –®–∞–≥ 2: –ö–∞–∫–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –Ω—É–∂–Ω—ã?")
            await query.edit_message_reply_markup(reply_markup=get_features_keyboard())

        elif data.startswith("step2:"):
            features = data.split(":", 1)[1]
            doc_ref.update({"features": features, "step": STEP_TIMELINE})
            await query.edit_message_text("üîπ –®–∞–≥ 3: –ö–∞–∫–∏–µ —Å—Ä–æ–∫–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏?")
            await query.edit_message_reply_markup(reply_markup=get_timeline_keyboard())

        elif data.startswith("step3:"):
            timeline = data.split(":", 1)[1]
            doc_ref.update({"timeline": timeline, "step": STEP_BUDGET})
            await query.edit_message_text("üîπ –®–∞–≥ 4: –í–∞—à –±—é–¥–∂–µ—Ç?")
            await query.edit_message_reply_markup(reply_markup=get_budget_keyboard())

        elif data.startswith("step4:"):
            budget = data.split(":", 1)[1]
            doc_ref.update({"budget": budget, "step": STEP_BUSINESS_NICHE})
            await query.edit_message_reply_markup(reply_markup=None)
            await query.message.reply_text(
                "üîπ –®–∞–≥ 5: –ù–∏—à–∞ –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞?\n"
                "–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º:",
                reply_markup=get_edit_keyboard()
            )

        elif data.startswith("step8:"):
            goal = data.split(":", 1)[1]
            doc_ref.update({"site_goal": goal, "step": "custom_goal" if goal == "–î—Ä—É–≥–æ–µ" else STEP_SITE_STYLE})
            if goal == "–î—Ä—É–≥–æ–µ":
                await query.message.reply_text("üîπ –£—Ç–æ—á–Ω–∏—Ç–µ —Ü–µ–ª—å —Å–∞–π—Ç–∞:", reply_markup=get_edit_keyboard())
            else:
                await query.message.reply_text(
                    "üîπ –®–∞–≥ 9: –ñ–µ–ª–∞–µ–º—ã–π —Å—Ç–∏–ª—å —Å–∞–π—Ç–∞?\n"
                    "–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º:",
                    reply_markup=get_edit_keyboard()
                )

        elif data == "edit_brief":
            # –ù–∞—á–∏–Ω–∞–µ–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            doc = doc_ref.get()
            if not doc.exists:
                await query.message.reply_text("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±—Ä–∏—Ñ–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
                return

            data = doc.to_dict()
            brief_number = data.get("brief_number", "BRF-000")

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –±—Ä–∏—Ñ–∞
            text = (
                f"üìù *–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—Ä–∏—Ñ–∞* `{brief_number}`\n\n"
                f"üë§ –ò–º—è: {update.effective_user.full_name}\n"
                f"üÜî ID: {update.effective_user.id}\n"
                f"üîó @: @{update.effective_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n"
                f"üåê –¢–∏–ø —Å–∞–π—Ç–∞: {data.get('type', '‚Äî')}\n"
                f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏: {data.get('features', '‚Äî')}\n"
                f"üìÖ –°—Ä–æ–∫–∏: {data.get('timeline', '‚Äî')}\n"
                f"üí∞ –ë—é–¥–∂–µ—Ç: {data.get('budget', '‚Äî')}\n\n"
                f"üéØ –ù–∏—à–∞: {data.get('business_niche', '‚Äî')}\n"
                f"üè¢ –û –∫–æ–º–ø–∞–Ω–∏–∏: {data.get('company_info', '‚Äî')}\n"
                f"üé® –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ: {data.get('inspiration', '‚Äî')}\n"
                f"üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: {data.get('materials', '‚Äî')}\n"
                f"üîç SEO: {data.get('seo_keywords', '‚Äî')}\n"
                f"‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã: {data.get('competitors', '‚Äî')}\n"
                f"üí° –ü—Ä–æ–±–ª–µ–º–∞: {data.get('product_problem', '‚Äî')}\n"
                f"üéØ –¶–µ–ª—å —Å–∞–π—Ç–∞: {data.get('site_goal', '‚Äî')}\n"
                f"üé® –°—Ç–∏–ª—å: {data.get('site_style', '‚Äî')}\n"
                f"üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {data.get('site_structure', '‚Äî')}\n"
                f"üìå –î–æ–ø. –∏–Ω—Ñ–æ: {data.get('extra_info', '‚Äî')}\n"
                f"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {data.get('contact', '‚Äî')}"
            )

            await query.message.reply_text(
                text,
                parse_mode="Markdown",
                reply_markup=get_save_keyboard()
            )
            doc_ref.update({"edit_mode": True})

        elif data == "save_and_resend":
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–Ω–æ–≤–∞
            doc = doc_ref.get()
            if not doc.exists:
                await query.message.reply_text("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±—Ä–∏—Ñ–∞.")
                return

            data = doc.to_dict()
            brief_number = data.get("brief_number", "BRF-000")

            # –§–æ—Ä–º–∏—Ä—É–µ–º –±—Ä–∏—Ñ
            brief = (
                f"üì© *–ù–æ–≤—ã–π –±—Ä–∏—Ñ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞* `{brief_number}`\n\n"
                f"üë§ –ò–º—è: {update.effective_user.full_name}\n"
                f"üÜî ID: {update.effective_user.id}\n"
                f"üîó @: @{update.effective_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n"
                f"üåê –¢–∏–ø —Å–∞–π—Ç–∞: {data.get('type', '‚Äî')}\n"
                f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏: {data.get('features', '‚Äî')}\n"
                f"üìÖ –°—Ä–æ–∫–∏: {data.get('timeline', '‚Äî')}\n"
                f"üí∞ –ë—é–¥–∂–µ—Ç: {data.get('budget', '‚Äî')}\n\n"
                f"üéØ –ù–∏—à–∞: {data.get('business_niche', '‚Äî')}\n"
                f"üè¢ –û –∫–æ–º–ø–∞–Ω–∏–∏: {data.get('company_info', '‚Äî')}\n"
                f"üé® –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ: {data.get('inspiration', '‚Äî')}\n"
                f"üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: {data.get('materials', '‚Äî')}\n"
                f"üîç SEO: {data.get('seo_keywords', '‚Äî')}\n"
                f"‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã: {data.get('competitors', '‚Äî')}\n"
                f"üí° –ü—Ä–æ–±–ª–µ–º–∞: {data.get('product_problem', '‚Äî')}\n"
                f"üéØ –¶–µ–ª—å —Å–∞–π—Ç–∞: {data.get('site_goal', '‚Äî')}\n"
                f"üé® –°—Ç–∏–ª—å: {data.get('site_style', '‚Äî')}\n"
                f"üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {data.get('site_structure', '‚Äî')}\n"
                f"üìå –î–æ–ø. –∏–Ω—Ñ–æ: {data.get('extra_info', '‚Äî')}\n"
                f"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {data.get('contact', '‚Äî')}"
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
            try:
                await context.bot.send_message(
                    chat_id=CHANNEL_ID,
                    text=brief,
                    parse_mode="Markdown"
                )
                print(f"[INFO] ‚úÖ –ë—Ä–∏—Ñ {brief_number} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª")
            except Exception as e:
                print(f"[ERROR] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

            # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—É
            await query.message.reply_text(
                f"‚úÖ –ë—Ä–∏—Ñ `{brief_number}` —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–Ω–æ–≤–∞!"
            )

            # –û—á–∏—Å—Ç–∫–∞
            doc_ref.delete()

        elif data == "cancel_edit":
            await query.message.reply_text("–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
            doc_ref.delete()

    except Exception as e:
        print(f"[ERROR] button_handler: {e}")
        await query.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ /start")


async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    doc_ref = DB.collection("users").document(str(user_id))
    doc = doc_ref.get()

    if not doc.exists:
        await update.message.reply_text("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –Ω–∞–∂–º–∏—Ç–µ /start")
        return

    data = doc.to_dict()
    step = data.get("step")

    try:
        text = update.message.text.strip()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤
        if step == STEP_BUSINESS_NICHE:
            doc_ref.update({
                "business_niche": text,
                "step": STEP_COMPANY_INFO
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 6: –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏\n"
                "–ò—Å—Ç–æ—Ä–∏—è, –º–∏—Å—Å–∏—è, –∫–æ–º–∞–Ω–¥–∞ ‚Äî —á—Ç–æ —É–≥–æ–¥–Ω–æ:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_COMPANY_INFO:
            doc_ref.update({
                "company_info": text,
                "step": STEP_INSPIRATION
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 7: –°—Å—ã–ª–∫–∏ –Ω–∞ —Å–∞–π—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω—Ä–∞–≤—è—Ç—Å—è\n"
                "–ù–∞–ø–∏—à–∏—Ç–µ 3-4 —Å—Å—ã–ª–∫–∏:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_INSPIRATION:
            doc_ref.update({
                "inspiration": text,
                "step": STEP_AVAILABLE_MATERIALS
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 8: –ß—Ç–æ —É –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –¥–ª—è —Å–∞–π—Ç–∞?\n"
                "–õ–æ–≥–æ—Ç–∏–ø, —Ñ–∏—Ä–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å, —Ç–µ–∫—Å—Ç—ã, —Ñ–æ—Ç–æ –∏ —Ç.–¥.:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_AVAILABLE_MATERIALS:
            doc_ref.update({
                "materials": text,
                "step": STEP_SEO_KEYWORDS
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 9: –ü–æ –∫–∞–∫–∏–º –∑–∞–ø—Ä–æ—Å–∞–º –≤–∞—Å –º–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ Google?\n"
                "–ù–∞–ø—Ä–∏–º–µ—Ä: '–∫—É–ø–∏—Ç—å –∫–æ—Ñ–µ –≤ –ê–ª–º–∞—Ç—ã', '–¥–∏–∑–∞–π–Ω –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞':",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_SEO_KEYWORDS:
            doc_ref.update({
                "seo_keywords": text,
                "step": STEP_COMPETITORS
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 10: –ö—Ç–æ –≤–∞—à–∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã?\n"
                "–£–∫–∞–∂–∏—Ç–µ —Å–∞–π—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –±—Ä–µ–Ω–¥–æ–≤:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_COMPETITORS:
            doc_ref.update({
                "competitors": text,
                "step": STEP_PRODUCT_PROBLEM
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 11: –ö–∞–∫—É—é –ø—Ä–æ–±–ª–µ–º—É —Ä–µ—à–∞–µ—Ç –≤–∞—à –ø—Ä–æ–¥—É–∫—Ç?\n"
                "–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_PRODUCT_PROBLEM:
            doc_ref.update({
                "product_problem": text,
                "step": STEP_SITE_GOALS
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 12: –ö–∞–∫–∏–µ —Ü–µ–ª–∏ –¥–æ–ª–∂–µ–Ω —Ä–µ—à–∏—Ç—å —Å–∞–π—Ç?",
                reply_markup=get_goals_keyboard()
            )

        elif step == "custom_goal":
            doc_ref.update({
                "site_goal": f"–î—Ä—É–≥–æ–µ: {text}",
                "step": STEP_SITE_STYLE
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 13: –ñ–µ–ª–∞–µ–º—ã–π —Å—Ç–∏–ª—å —Å–∞–π—Ç–∞?\n"
                "–û–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_SITE_STYLE:
            doc_ref.update({
                "site_style": text,
                "step": STEP_SITE_STRUCTURE
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 14: –ö–∞–∫–∏–µ —Ä–∞–∑–¥–µ–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ —Å–∞–π—Ç–µ?\n"
                "–û–ø–∏—à–∏—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É:",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_SITE_STRUCTURE:
            doc_ref.update({
                "site_structure": text,
                "step": STEP_EXTRA_INFO
            })
            await update.message.reply_text(
                "üîπ –®–∞–≥ 15: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n"
                "–ß—Ç–æ –µ—â—ë –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å?",
                reply_markup=get_edit_keyboard()
            )

        elif step == STEP_EXTRA_INFO:
            doc_ref.update({
                "extra_info": text,
                "step": STEP_CONTACT
            })
            await update.message.reply_text(
                "üîπ –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–≥: –∫–æ–Ω—Ç–∞–∫—Ç (email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω):",
                reply_markup=ReplyKeyboardRemove()
            )

        elif step == STEP_CONTACT:
            if not is_valid_contact(text):
                await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω.")
                return

            # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–º–µ—Ä–∞ –±—Ä–∏—Ñ–∞
            counter_ref = DB.collection("counters").document("brief_counter")
            counter = counter_ref.get()
            if counter.exists:
                num = counter.to_dict().get("value", 0) + 1
            else:
                num = 1
            counter_ref.set({"value": num})
            brief_number = f"BRF-{num:03d}"

            doc_ref.update({"contact": text, "brief_number": brief_number})

            # –§–æ—Ä–º–∏—Ä—É–µ–º –±—Ä–∏—Ñ
            brief = (
                f"üì© *–ù–æ–≤—ã–π –±—Ä–∏—Ñ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞* `{brief_number}`\n\n"
                f"üë§ –ò–º—è: {update.effective_user.full_name}\n"
                f"üÜî ID: {update.effective_user.id}\n"
                f"üîó @: @{update.effective_user.username or '–Ω–µ —É–∫–∞–∑–∞–Ω'}\n\n"
                f"üåê –¢–∏–ø —Å–∞–π—Ç–∞: {data.get('type', '‚Äî')}\n"
                f"‚öôÔ∏è –§—É–Ω–∫—Ü–∏–∏: {data.get('features', '‚Äî')}\n"
                f"üìÖ –°—Ä–æ–∫–∏: {data.get('timeline', '‚Äî')}\n"
                f"üí∞ –ë—é–¥–∂–µ—Ç: {data.get('budget', '‚Äî')}\n\n"
                f"üéØ –ù–∏—à–∞: {data.get('business_niche', '‚Äî')}\n"
                f"üè¢ –û –∫–æ–º–ø–∞–Ω–∏–∏: {data.get('company_info', '‚Äî')}\n"
                f"üé® –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ: {data.get('inspiration', '‚Äî')}\n"
                f"üì¶ –ú–∞—Ç–µ—Ä–∏–∞–ª—ã: {data.get('materials', '‚Äî')}\n"
                f"üîç SEO: {data.get('seo_keywords', '‚Äî')}\n"
                f"‚öîÔ∏è –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã: {data.get('competitors', '‚Äî')}\n"
                f"üí° –ü—Ä–æ–±–ª–µ–º–∞: {data.get('product_problem', '‚Äî')}\n"
                f"üéØ –¶–µ–ª—å —Å–∞–π—Ç–∞: {data.get('site_goal', '‚Äî')}\n"
                f"üé® –°—Ç–∏–ª—å: {data.get('site_style', '‚Äî')}\n"
                f"üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞: {data.get('site_structure', '‚Äî')}\n"
                f"üìå –î–æ–ø. –∏–Ω—Ñ–æ: {data.get('extra_info', '‚Äî')}\n"
                f"üìû –ö–æ–Ω—Ç–∞–∫—Ç: {text}"
            )

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–∞–Ω–∞–ª
            try:
                await context.bot.send_message(
                    chat_id=CHANNEL_ID,
                    text=brief,
                    parse_mode="Markdown"
                )
                print(f"[INFO] ‚úÖ –ë—Ä–∏—Ñ {brief_number} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –∫–∞–Ω–∞–ª")
            except Exception as e:
                print(f"[ERROR] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {e}")

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç—É
            await update.message.reply_text(
                f"‚úÖ –°–ø–∞—Å–∏–±–æ! –Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à –±—Ä–∏—Ñ `{brief_number}`.\n"
                "–°–≤—è–∂—É—Å—å —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
                reply_markup=get_edit_keyboard()
            )

            # –û—á–∏—Å—Ç–∫–∞
            doc_ref.delete()

    except Exception as e:
        print(f"[ERROR] text_handler: {e}")
        await update.message.reply_text("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")


# === –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞ ===
def is_valid_contact(text: str) -> bool:
    text = text.strip()
    import re
    email = r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'
    phone = r'^\+?[\d\s\-\(\)]{7,}$'
    return re.match(email, text) or re.match(phone, text)